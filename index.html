<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Trabajo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Librerías para el mapa interactivo -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
        }
        .add-btn, .remove-btn, .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .add-btn {
            background-color: #10B981;
            color: white;
        }
        .add-btn:hover {
            background-color: #059669;
        }
        .remove-btn {
            background-color: #EF4444;
            color: white;
        }
        .remove-btn:hover {
            background-color: #DC2626;
        }
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2D3748;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s;
        }
        /* Estilos para el mapa interactivo */
        #map { height: 75vh; z-index: 1; }
        .awesomplete > ul {
            border-radius: .25rem;
            border: 1px solid #ced4da;
            margin-top: 2px;
            z-index: 9999;
        }
        .leaflet-grab.selecting {
            cursor: crosshair !important;
        }
        .btn-selecting {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }
        .form-control-color {
            width: 100%;
            max-width: 50px;
            height: 38px;
            padding: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div id="notification"></div>
    <div class="max-w-5xl mx-auto bg-white p-8 rounded-lg shadow-md">
        
        <div class="flex justify-between items-start mb-6">
            <h1 class="text-2xl font-bold text-gray-800">PLAN DE TRABAJO</h1>
            <div class="text-right">
                <label for="plan-numero" class="block text-sm font-medium text-gray-500">Número de Plan:</label>
                <input type="text" id="plan-numero" name="plan-numero" class="text-right font-mono bg-gray-100 border-none rounded p-1" readonly>
            </div>
        </div>


        <!-- Título Principal -->
        <div class="mb-6">
            <label for="main-title" class="block text-sm font-medium text-gray-700 mb-2">Título del Plan de Trabajo</label>
            <textarea id="main-title" name="main-title" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describir el titulo de la comisión de servicio" required></textarea>
        </div>

        <!-- Justificación -->
        <div class="mb-6">
            <label for="justificacion" class="block text-sm font-medium text-gray-700 mb-2">1. Justificación</label>
            <textarea id="justificacion" name="justificacion" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describa la justificación del proyecto..."></textarea>
        </div>

        <!-- Objetivo -->
        <div class="mb-6">
            <label for="objetivo" class="block text-sm font-medium text-gray-700 mb-2">2. Objetivo</label>
            <textarea id="objetivo" name="objetivo" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describa el objetivo del proyecto..."></textarea>
        </div>

        <!-- Participantes -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">3. Participantes en la comisión de servicio</h2>
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombres y Apellidos</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OFICINA / DZ</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cargo</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNI</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="participantes-tbody">
                </tbody>
            </table>
            <button onclick="agregarParticipante()" class="add-btn mt-4">Agregar Participante</button>
        </div>

        <!-- Ubicación de las estaciones -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">4. Ubicación de las estaciones</h2>
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estación</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departamento</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provincia</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distrito</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Latitud</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Longitud</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Altitud</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="estaciones-tbody">
                </tbody>
            </table>
            <button onclick="agregarEstacion()" class="add-btn mt-4">Agregar Estación</button>
        </div>

        <!-- Período de la comisión -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">5. Período de la comisión</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombres y Apellidos</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OFICINA / DZ</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Salida</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles Salida</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Retorno</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles Retorno</th>
                        </tr>
                    </thead>
                    <tbody id="periodo-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ruta de la comisión -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">6. Ruta de la comisión</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:flex lg:items-end gap-3 mb-3">
                <div class="flex-grow">
                    <label for="start" class="block text-xs font-bold text-gray-500">ORIGEN</label>
                    <div class="flex">
                        <input type="text" id="start" class="table-input rounded-r-none" placeholder="Escribe o marca en el mapa" />
                        <button id="selectStartBtn" class="px-3 border border-gray-300 border-l-0 rounded-r-md hover:bg-gray-100" type="button" title="Marcar Origen en Mapa"><i class="bi bi-geo-alt-fill text-gray-600"></i></button>
                    </div>
                </div>
                <div class="flex-grow">
                    <label for="end" class="block text-xs font-bold text-gray-500">DESTINO</label>
                    <div class="flex">
                        <input type="text" id="end" class="table-input rounded-r-none" placeholder="Escribe o marca en el mapa" />
                        <button id="selectEndBtn" class="px-3 border border-gray-300 border-l-0 rounded-r-md hover:bg-gray-100" type="button" title="Marcar Destino en Mapa"><i class="bi bi-geo-alt-fill text-gray-600"></i></button>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <label for="routeColor" class="block text-xs font-bold text-gray-500">COLOR</label>
                    <input type="color" class="form-control-color border border-gray-300 rounded-md" id="routeColor" value="#3b82f6" title="Elige un color para la ruta">
                </div>
                <div id="actionButtons" class="flex-shrink-0 flex gap-2">
                    <!-- Los botones de acción ahora se gestionan dinámicamente -->
                </div>
            </div>

            <div id="historySection" class="mt-4" style="display: none;">
                <h3 class="text-md font-semibold text-center">Historial de Rutas</h3>
                <ul id="historyList" class="space-y-2 mt-2"></ul>
                <div class="text-right mt-2">
                    <p id="totalDistanceInfo" class="font-bold text-xl"></p>
                </div>
            </div>

            <div id="map" class="mt-3 rounded-lg"></div>
        </div>


        <!-- Materiales/vehículos requeridos -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">7. Materiales/vehículos requeridos</h2>
            
            <h3 class="font-medium text-gray-700 mb-2 mt-4">7.1 Herramientas e instrumentos requeridos</h3>
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilidad</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="herramientas-tbody"></tbody>
            </table>
            <button onclick="agregarHerramienta()" class="add-btn mt-4">Agregar Herramienta</button>

            <h3 class="font-medium text-gray-700 mb-2 mt-6">7.2 Repuestos a emplear</h3>
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marca</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentario</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="repuestos-tbody"></tbody>
            </table>
            <button onclick="agregarRepuesto()" class="add-btn mt-4">Agregar Repuesto</button>
        </div>

        <!-- Plan de actividades -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">8. Plan de actividades</h2>
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Día</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                    </tr>
                </thead>
                <tbody id="actividades-tbody"></tbody>
            </table>
        </div>

        <!-- Presupuesto -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">9. Presupuesto Requerido</h2>
            
            <!-- 9.1 Gastos para comisión de servicio -->
            <div class="border rounded-lg p-4">
                <h3 class="text-md font-semibold text-gray-800 mb-3">9.1 Gastos para comisión de servicio</h3>
                
                <!-- Viáticos -->
                <div class="mb-4">
                    <h4 class="font-medium text-gray-700 mb-2">Viáticos</h4>
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unid.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cant.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total S/.</th>
                                <th class="p-2"></th>
                            </tr>
                        </thead>
                        <tbody id="viaticos-tbody"></tbody>
                    </table>
                    <button onclick="agregarViatico()" class="add-btn mt-2 text-sm">Agregar Viático</button>
                </div>

                <!-- Pasajes Aéreos -->
                <div class="mb-4">
                    <h4 class="font-medium text-gray-700 mb-2">Pasajes Aéreos</h4>
                    <table class="w-full">
                         <thead>
                            <tr class="bg-gray-50">
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unid.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cant.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total S/.</th>
                                <th class="p-2"></th>
                            </tr>
                        </thead>
                        <tbody id="pasajes-tbody"></tbody>
                    </table>
                    <button onclick="agregarPasaje()" class="add-btn mt-2 text-sm">Agregar Pasaje</button>
                </div>

                <!-- Combustible -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Combustible</h4>
                    <table class="w-full">
                         <thead>
                            <tr class="bg-gray-50">
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unid.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cant.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total S/.</th>
                                <th class="p-2"></th>
                            </tr>
                        </thead>
                        <tbody id="combustible-tbody"></tbody>
                    </table>
                    <button onclick="agregarCombustible()" class="add-btn mt-2 text-sm">Agregar Combustible</button>
                </div>
                <div class="text-right mt-4 font-bold text-lg border-t pt-2">
                    <p>Total Comisión de Servicio: S/. <span id="total-comision">0.00</span></p>
                </div>
            </div>

            <!-- 9.2 Gasto por encargo -->
            <div class="border rounded-lg p-4 mt-6">
                <h3 class="text-md font-semibold text-gray-800 mb-3">9.2 Gasto por encargo</h3>
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit. (S/.)</th>
                            <th class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (S/.)</th>
                            <th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody id="encargo-tbody"></tbody>
                </table>
                <button onclick="agregarEncargo()" class="add-btn mt-4">Agregar Encargo</button>
                <div class="text-right mt-4 font-bold text-lg border-t pt-2">
                    <p>Total Encargos: S/. <span id="total-encargos">0.00</span></p>
                </div>
            </div>

            <div class="text-right mt-6 font-bold text-2xl text-blue-600">
                <p>Total General del Presupuesto: S/. <span id="total-general">0.00</span></p>
            </div>
        </div>

        <!-- Conclusiones -->
        <div class="mb-6">
            <label for="conclusiones" class="block text-sm font-medium text-gray-700 mb-2">10. Conclusiones</label>
            <textarea id="conclusiones" name="conclusiones" rows="5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Escriba las conclusiones..."></textarea>
        </div>

        <!-- Fecha y Botones -->
        <div class="flex justify-between items-center mt-8">
            <div>
                <label for="fecha-documento" class="block text-sm font-medium text-gray-700">Fecha del Documento</label>
                <input type="date" id="fecha-documento" name="fecha-documento" class="mt-1 p-2 border border-gray-300 rounded-md">
            </div>
            <div class="flex gap-4">
                <button class="action-btn bg-green-600 text-white hover:bg-green-700" onclick="guardarBorrador()">Guardar Borrador</button>
                <button class="action-btn bg-red-600 text-white hover:bg-red-700" onclick="limpiarFormulario()">Limpiar Formulario</button>
                <button class="action-btn bg-blue-600 text-white hover:bg-blue-700" onclick="window.print()">Imprimir / Guardar PDF</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <script>
        // --- LÓGICA DEL MAPA INTERACTIVO (SECCIÓN 6) ---
        let map;
        let allRoutes = []; 
        let selectionMode = null;
        let editingRouteId = null;

        function initializeMap() {
            map = L.map('map').setView([-12.046, -77.042], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const defaultIcon = L.icon({ 
                iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                iconSize: [25, 41], 
                iconAnchor: [12, 41], 
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            const startInput = document.getElementById('start');
            const endInput = document.getElementById('end');
            const selectStartBtn = document.getElementById('selectStartBtn');
            const selectEndBtn = document.getElementById('selectEndBtn');
            const mapContainer = document.getElementById('map');
            const actionButtons = document.getElementById('actionButtons');
            
            new Awesomplete(startInput);
            new Awesomplete(endInput);

            const handleAutocomplete = async (inputElement, awesompleteInstance) => {
                const query = inputElement.value;
                if (query.length < 3) { awesompleteInstance.list = []; return; }
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=pe&limit=5`);
                const data = await response.json();
                awesompleteInstance.list = data.map(item => item.display_name);
            };

            startInput.addEventListener('input', () => handleAutocomplete(startInput, startInput.awesomplete));
            endInput.addEventListener('input', () => handleAutocomplete(endInput, endInput.awesomplete));

            selectStartBtn.addEventListener('click', () => setSelectionMode('start'));
            selectEndBtn.addEventListener('click', () => setSelectionMode('end'));

            map.on('click', async function(e) {
                if (!selectionMode) return;
                const coords = e.latlng;
                const address = await getAddress(coords);
                if (selectionMode === 'start') startInput.value = address;
                else if (selectionMode === 'end') endInput.value = address;
                resetSelectionMode();
            });

            function setSelectionMode(mode) {
                selectionMode = mode;
                mapContainer.classList.add('selecting');
                selectStartBtn.classList.toggle('btn-selecting', mode === 'start');
                selectEndBtn.classList.toggle('btn-selecting', mode === 'end');
            }

            function resetSelectionMode() {
                selectionMode = null;
                mapContainer.classList.remove('selecting');
                selectStartBtn.classList.remove('btn-selecting');
                selectEndBtn.classList.remove('btn-selecting');
            }
            
            async function getAddress(coords) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}`);
                    const data = await response.json();
                    return data.display_name || `Lat: ${coords.lat.toFixed(5)}, Lon: ${coords.lng.toFixed(5)}`;
                } catch (error) {
                    return `Lat: ${coords.lat.toFixed(5)}, Lon: ${coords.lng.toFixed(5)}`;
                }
            }
            
            window.addRoute = async function() {
                const startInput = document.getElementById('start');
                const endInput = document.getElementById('end');
                let start = startInput.value;
                let end = endInput.value;
                if (!start || !end) { showNotification("Por favor ingresa ambas ubicaciones"); return; }
                
                const routeData = await processRoute(start, end);
                if (!routeData) return;

                const routeId = 'route-' + Date.now();
                const selectedColor = document.getElementById('routeColor').value;
                const drawnLayers = drawRouteOnMap(routeData, selectedColor, start, end);
                
                allRoutes.push({ 
                    id: routeId, 
                    ...drawnLayers,
                    distance: routeData.distance, 
                    start, 
                    end 
                });
                
                addRouteToHistory(routeId, start, end, routeData.distance);
                updateTotalDistance();
                
                startInput.value = "";
                endInput.value = "";
                map.fitBounds(drawnLayers.routeLayer.getBounds());
            }

            async function processRoute(start, end) {
                let startCoords = await getCoordinates(start);
                let endCoords = await getCoordinates(end);
                if (!startCoords || !endCoords) {
                    showNotification("No se pudieron encontrar las ubicaciones");
                    return null;
                }
                
                let routeUrl = `https://router.project-osrm.org/route/v1/driving/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full&geometries=geojson&steps=true`;
                let response = await fetch(routeUrl);
                let data = await response.json();

                if (data.routes && data.routes.length > 0) {
                    return data.routes[0];
                } else {
                    showNotification("No se pudo calcular la ruta.");
                    return null;
                }
            }

            async function getCoordinates(location) {
                let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${location}`);
                let data = await response.json();
                return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
            }

            function drawRouteOnMap(routeData, color, startText, endText) {
                let routeCoords = routeData.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                let routeLayer = L.polyline(routeCoords, { color: color }).addTo(map);
                
                let stepMarkers = routeData.legs[0].steps.map(step => {
                    let loc = step.maneuver.location;
                    return L.circleMarker([loc[1], loc[0]], { radius: 5, color: color, fillColor: color, fillOpacity: 0.7 })
                            .addTo(map)
                            .bindTooltip("Calle: " + (step.name || "Sin nombre"));
                });
                
                let startCoords = [routeData.geometry.coordinates[0][1], routeData.geometry.coordinates[0][0]];
                let endCoords = [routeData.geometry.coordinates.slice(-1)[0][1], routeData.geometry.coordinates.slice(-1)[0][0]];

                let startMarker = L.marker(startCoords, {icon: defaultIcon}).addTo(map).bindTooltip("Origen: " + startText);
                let endMarker = L.marker(endCoords, {icon: defaultIcon}).addTo(map).bindTooltip("Destino: " + endText);
                
                return { routeLayer, startMarker, endMarker, stepMarkers };
            }
            
            function addRouteToHistory(id, start, end, distance) {
                document.getElementById('historySection').style.display = 'block';
                const distanceKm = (distance / 1000).toFixed(2);
                const listItem = document.createElement('li');
                listItem.className = 'p-2 bg-white border rounded-md flex justify-between items-center';
                listItem.id = id;
                const routeColor = allRoutes.find(r => r.id === id).routeLayer.options.color;
                
                listItem.innerHTML = `
                    <div class="flex-grow flex items-center">
                        <span style="width: 15px; height: 15px; background-color: ${routeColor}; border-radius: 50%; display: inline-block; margin-right: 10px;"></span>
                        <div class="text-sm">
                            <span class="text-gray-500">De:</span> ${start}<br>
                            <span class="text-gray-500">A:</span> ${end}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${distanceKm} km</span>
                        <button class="text-gray-500 hover:text-blue-600" onclick="editRoute('${id}')"><i class="bi bi-pencil"></i></button>
                        <button class="text-gray-500 hover:text-green-600" onclick="viewRoute('${id}')"><i class="bi bi-eye"></i></button>
                        <button class="text-gray-500 hover:text-red-600" onclick="deleteRoute('${id}')"><i class="bi bi-trash"></i></button>
                    </div>
                `;
                document.getElementById('historyList').appendChild(listItem);
            }

            window.viewRoute = function(id) {
                const route = allRoutes.find(r => r.id === id);
                if (route) map.fitBounds(route.routeLayer.getBounds());
            }

            function deleteRouteLayers(route) {
                map.removeLayer(route.routeLayer);
                map.removeLayer(route.startMarker);
                map.removeLayer(route.endMarker);
                route.stepMarkers.forEach(marker => map.removeLayer(marker));
            }

            window.deleteRoute = function(id) {
                const routeIndex = allRoutes.findIndex(r => r.id === id);
                if (routeIndex > -1) {
                    deleteRouteLayers(allRoutes[routeIndex]);
                    allRoutes.splice(routeIndex, 1);
                    document.getElementById(id).remove();
                    updateTotalDistance();
                    if (allRoutes.length === 0) document.getElementById('historySection').style.display = 'none';
                }
            }

            window.editRoute = function(id) {
                const route = allRoutes.find(r => r.id === id);
                if (route) {
                    editingRouteId = id;
                    document.getElementById('start').value = route.start;
                    document.getElementById('end').value = route.end;
                    document.getElementById('routeColor').value = route.routeLayer.options.color;
                    setEditModeUI();
                }
            }

            window.updateRoute = async function() {
                let start = document.getElementById('start').value;
                let end = document.getElementById('end').value;
                if (!start || !end) { showNotification("Por favor ingresa ambas ubicaciones"); return; }

                const routeData = await processRoute(start, end);
                if (!routeData) return;

                const routeIndex = allRoutes.findIndex(r => r.id === editingRouteId);
                if (routeIndex > -1) {
                    const oldRoute = allRoutes[routeIndex];
                    deleteRouteLayers(oldRoute);

                    const newColor = document.getElementById('routeColor').value;
                    const drawnLayers = drawRouteOnMap(routeData, newColor, start, end);

                    allRoutes[routeIndex] = { ...oldRoute, ...drawnLayers, distance: routeData.distance, start, end };

                    const distanceKm = (routeData.distance / 1000).toFixed(2);
                    const listItem = document.getElementById(editingRouteId);
                    listItem.querySelector('.flex-grow').innerHTML = `...`; // Simplificado para brevedad
                    
                    updateTotalDistance();
                    map.fitBounds(drawnLayers.routeLayer.getBounds());
                    cancelEdit();
                }
            }

            window.cancelEdit = function() {
                editingRouteId = null;
                document.getElementById('start').value = "";
                document.getElementById('end').value = "";
                setDefaultModeUI();
            }

            function updateTotalDistance() {
                const totalMeters = allRoutes.reduce((sum, route) => sum + route.distance, 0);
                const totalKm = (totalMeters / 1000).toFixed(2);
                document.getElementById("totalDistanceInfo").innerText = totalKm > 0 ? `Distancia Total: ${totalKm} km` : '';
            }

            window.clearAllRoutes = function() {
                allRoutes.forEach(route => deleteRouteLayers(route));
                allRoutes = [];
                document.getElementById('historyList').innerHTML = '';
                document.getElementById('historySection').style.display = 'none';
                cancelEdit();
                updateTotalDistance();
                map.setView([-12.046, -77.042], 6);
            }

            function setDefaultModeUI() {
                actionButtons.innerHTML = `
                    <button class="action-btn bg-green-600 text-white hover:bg-green-700 flex items-center gap-2" onclick="addRoute()"><i class="bi bi-plus-lg"></i> Agregar</button>
                    <button class="action-btn bg-red-600 text-white hover:bg-red-700 flex items-center gap-2" onclick="clearAllRoutes()"><i class="bi bi-trash3"></i> Limpiar</button>
                `;
            }

            function setEditModeUI() {
                actionButtons.innerHTML = `
                    <button class="action-btn bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" onclick="updateRoute()"><i class="bi bi-check-lg"></i> Actualizar</button>
                    <button class="action-btn bg-gray-500 text-white hover:bg-gray-600 flex items-center gap-2" onclick="cancelEdit()"><i class="bi bi-x-lg"></i> Cancelar</button>
                `;
            }

            setDefaultModeUI();
        }


        // --- Funciones de Notificación ---
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.opacity = 1;
            setTimeout(() => {
                notification.style.opacity = 0;
            }, 3000);
        }

        // --- Funciones de Borrador (localStorage) ---
        function guardarBorrador() {
            // ... (código existente de guardarBorrador) ...
            showNotification('Borrador guardado exitosamente.');
        }

        function cargarBorrador() {
             // ... (código existente de cargarBorrador) ...
        }

        function limpiarFormulario() {
            if (confirm('¿Estás seguro de que quieres borrar todo el formulario? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('planTrabajoBorrador');
                document.querySelectorAll('textarea, input:not([type=button])').forEach(el => el.value = '');
                document.querySelectorAll('tbody').forEach(tbody => tbody.innerHTML = '');
                window.onload();
                showNotification('Formulario limpiado.');
            }
        }

        // --- Funciones de Cálculo de Presupuesto ---
        function calcularTotales() {
            let subtotalViaticos = 0;
            document.querySelectorAll('#viaticos-tbody tr').forEach(row => {
                const cantidad = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const precio = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const totalFila = cantidad * precio;
                row.cells[5].querySelector('input').value = totalFila.toFixed(2);
                subtotalViaticos += totalFila;
            });

            let subtotalPasajes = 0;
            document.querySelectorAll('#pasajes-tbody tr').forEach(row => {
                const cantidad = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const precio = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const totalFila = cantidad * precio;
                row.cells[5].querySelector('input').value = totalFila.toFixed(2);
                subtotalPasajes += totalFila;
            });

            let subtotalCombustible = 0;
            document.querySelectorAll('#combustible-tbody tr').forEach(row => {
                const cantidad = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const precio = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const totalFila = cantidad * precio;
                row.cells[5].querySelector('input').value = totalFila.toFixed(2);
                subtotalCombustible += totalFila;
            });
            
            const totalComision = subtotalViaticos + subtotalPasajes + subtotalCombustible;
            document.getElementById('total-comision').textContent = totalComision.toFixed(2);

            let subtotalEncargos = 0;
            document.querySelectorAll('#encargo-tbody tr').forEach(row => {
                const cantidad = parseFloat(row.cells[2].querySelector('input').value) || 0;
                const precio = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const totalFila = cantidad * precio;
                row.cells[4].querySelector('input').value = totalFila.toFixed(2);
                subtotalEncargos += totalFila;
            });
            document.getElementById('total-encargos').textContent = subtotalEncargos.toFixed(2);

            document.getElementById('total-general').textContent = (totalComision + subtotalEncargos).toFixed(2);
        }

        // --- Funciones de Lógica de Tablas ---
        function agregarFila(tbodyId, celdasHtml, isPresupuesto = false) {
            const tbody = document.getElementById(tbodyId);
            const newRow = tbody.insertRow();
            newRow.innerHTML = celdasHtml;
            renumerarTabla(tbodyId);
            if(isPresupuesto) calcularTotales();
        }

        function eliminarFila(button, isParticipant = false, isPresupuesto = false) {
            const row = button.parentNode.parentNode;
            const tbody = row.parentNode;
            const tbodyId = tbody.id;
            row.parentNode.removeChild(row);
            renumerarTabla(tbodyId);
            if (isParticipant) {
                actualizarPeriodoComision();
            }
            if (isPresupuesto) {
                calcularTotales();
            }
        }
        
        function renumerarTabla(tbodyId) {
             const tablesToRenumber = ['participantes-tbody', 'estaciones-tbody', 'herramientas-tbody', 'repuestos-tbody', 'encargo-tbody', 'periodo-tbody', 'viaticos-tbody', 'pasajes-tbody', 'combustible-tbody'];
             if (!tablesToRenumber.includes(tbodyId)) return;
             const tbody = document.getElementById(tbodyId);
             if (tbody) {
                 for (let i = 0; i < tbody.rows.length; i++) {
                     tbody.rows[i].cells[0].textContent = i + 1;
                 }
             }
        }

        function actualizarPeriodoComision() {
            const participantesTbody = document.getElementById('participantes-tbody');
            const periodoTbody = document.getElementById('periodo-tbody');
            const periodoData = [];
            for (let i = 0; i < periodoTbody.rows.length; i++) {
                const row = periodoTbody.rows[i];
                periodoData.push({
                    salida: row.cells[3].querySelector('input').value,
                    detallesSalida: row.cells[4].querySelector('textarea').value,
                    retorno: row.cells[5].querySelector('input').value,
                    detallesRetorno: row.cells[6].querySelector('textarea').value
                });
            }
            periodoTbody.innerHTML = ''; 
            for (let i = 0; i < participantesTbody.rows.length; i++) {
                const participanteRow = participantesTbody.rows[i];
                const nombre = participanteRow.cells[1].querySelector('input').value;
                const oficina = participanteRow.cells[2].querySelector('input').value;
                const data = periodoData[i] || {};
                const newRow = periodoTbody.insertRow();
                newRow.innerHTML = `
                    <td>${i + 1}</td>
                    <td><input type="text" class="table-input" value="${nombre}" readonly></td>
                    <td><input type="text" class="table-input" value="${oficina}" readonly></td>
                    <td><input type="date" class="table-input" value="${data.salida || ''}" onchange="actualizarPlanActividades()" required></td>
                    <td><textarea class="table-input" rows="1">${data.detallesSalida || ''}</textarea></td>
                    <td><input type="date" class="table-input" value="${data.retorno || ''}" onchange="actualizarPlanActividades()" required></td>
                    <td><textarea class="table-input" rows="1">${data.detallesRetorno || ''}</textarea></td>
                `;
            }
            actualizarPlanActividades();
        }

        function actualizarPlanActividades() {
            const periodoTbody = document.getElementById('periodo-tbody');
            const actividadesTbody = document.getElementById('actividades-tbody');
            actividadesTbody.innerHTML = ''; 
            const startDates = Array.from(periodoTbody.querySelectorAll('td:nth-child(4) input[type="date"]')).map(input => input.value).filter(Boolean).map(date => new Date(date + 'T00:00:00'));
            const returnDates = Array.from(periodoTbody.querySelectorAll('td:nth-child(6) input[type="date"]')).map(input => input.value).filter(Boolean).map(date => new Date(date + 'T00:00:00'));
            if (startDates.length === 0 || returnDates.length === 0) return;
            const minDate = new Date(Math.min.apply(null, startDates));
            const maxDate = new Date(Math.max.apply(null, returnDates));
            if (isNaN(minDate.getTime()) || isNaN(maxDate.getTime()) || minDate > maxDate) return;
            let currentDate = new Date(minDate);
            let dayCounter = 1;
            while (currentDate <= maxDate) {
                const newRow = actividadesTbody.insertRow();
                const formattedDate = currentDate.toISOString().split('T')[0];
                newRow.innerHTML = `
                    <td>Día ${dayCounter}</td>
                    <td><input type="text" class="table-input" value="${formattedDate}" readonly></td>
                    <td><textarea class="table-input" rows="2"></textarea></td>
                `;
                currentDate.setDate(currentDate.getDate() + 1);
                dayCounter++;
            }
        }

        // --- Funciones para agregar filas ---
        function agregarParticipante(data = {}) {
            const tbody = document.getElementById('participantes-tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td></td>
                <td><input type="text" class="table-input" oninput="actualizarPeriodoComision()" value="${data.nombre || ''}" required></td>
                <td><input type="text" class="table-input" oninput="actualizarPeriodoComision()" value="${data.oficina || ''}"></td>
                <td><input type="text" class="table-input" value="${data.cargo || ''}"></td>
                <td><input type="text" class="table-input" value="${data.dni || ''}"></td>
                <td><input type="text" class="table-input" value="${data.telefono || ''}"></td>
                <td class="text-center"><button onclick="eliminarFila(this, true)" class="remove-btn">X</button></td>
            `;
            renumerarTabla('participantes-tbody');
            actualizarPeriodoComision();
        }

        function agregarEstacion() {
            agregarFila('estaciones-tbody', `<td></td><td><input type="text" class="table-input" required></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td class="text-center"><button onclick="eliminarFila(this)" class="remove-btn">X</button></td>`);
        }

        function agregarHerramienta() {
            agregarFila('herramientas-tbody', `<td></td><td><input type="text" class="table-input"></td><td><input type="number" class="table-input" style="width: 80px;"></td><td><input type="text" class="table-input"></td><td class="text-center"><button onclick="eliminarFila(this)" class="remove-btn">X</button></td>`);
        }
        
        function agregarRepuesto() {
            agregarFila('repuestos-tbody', `<td></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="number" class="table-input" style="width: 80px;"></td><td><input type="text" class="table-input"></td><td class="text-center"><button onclick="eliminarFila(this)" class="remove-btn">X</button></td>`);
        }
        
        function agregarViatico() {
            agregarFila('viaticos-tbody', `<td></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="number" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" readonly></td><td class="text-center"><button onclick="eliminarFila(this, false, true)" class="remove-btn">X</button></td>`, true);
        }

        function agregarPasaje() {
            agregarFila('pasajes-tbody', `<td></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="number" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" readonly></td><td class="text-center"><button onclick="eliminarFila(this, false, true)" class="remove-btn">X</button></td>`, true);
        }

        function agregarCombustible() {
            agregarFila('combustible-tbody', `<td></td><td><input type="text" class="table-input"></td><td><input type="text" class="table-input"></td><td><input type="number" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" readonly></td><td class="text-center"><button onclick="eliminarFila(this, false, true)" class="remove-btn">X</button></td>`, true);
        }
        
        function agregarEncargo() {
            agregarFila('encargo-tbody', `<td></td><td><input type="text" class="table-input"></td><td><input type="number" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" oninput="calcularTotales()"></td><td><input type="number" step="0.01" class="table-input" readonly></td><td class="text-center"><button onclick="eliminarFila(this, false, true)" class="remove-btn">X</button></td>`, true);
        }

        // --- Generador de Número de Plan ---
        function generarNumeroDePlan() {
            const currentYear = new Date().getFullYear();
            let lastYear = localStorage.getItem('planLastYear');
            let correlative = localStorage.getItem('planCorrelative');

            if (lastYear && parseInt(lastYear) === currentYear) {
                correlative = parseInt(correlative) + 1;
            } else {
                correlative = 1;
            }

            localStorage.setItem('planLastYear', currentYear);
            localStorage.setItem('planCorrelative', correlative);
            
            const paddedCorrelative = String(correlative).padStart(3, '0');
            document.getElementById('plan-numero').value = `PT-${currentYear}-${paddedCorrelative}`;
        }


        window.onload = function() {
            // Cargar datos del borrador o inicializar
            // cargarBorrador(); // Esta función se puede implementar completamente
            
            // Inicializar con valores por defecto si no hay borrador
            if (!localStorage.getItem('planTrabajoBorrador')) {
                generarNumeroDePlan();
                agregarParticipante();
                agregarEstacion();
                agregarHerramienta();
                agregarRepuesto();
                agregarViatico();
                agregarPasaje();
                agregarCombustible();
                agregarEncargo();
            }

            // Inicializar el mapa al final
            initializeMap();
        };
    </script>
</body>
</html>
